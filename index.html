<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Nexus ‚Äî World Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Nunito+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="style.css"/>
<!-- PeerJS for real-time collaboration -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

<a href="#canvas" class="skip">Skip to canvas</a>
<div id="sr-status" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- HEADER -->
<header class="header" role="banner">
  <span class="logo" aria-label="Nexus World Builder">NEXUS<span>World Builder</span></span>
  <div class="hdiv" aria-hidden="true"></div>
  <input class="world-input" id="worldName" value="New World" placeholder="World name‚Ä¶" aria-label="World name" autocomplete="off" spellcheck="false"/>
  <div class="spacer"></div>
  <div role="toolbar" aria-label="File actions" style="display:flex;gap:.32rem;align-items:center">
    <button class="btn" id="btnImport" aria-label="Import world from JSON file">Import</button>
    <button class="btn btn-primary" id="btnExport" aria-label="Export world to JSON file">Export</button>
    <button class="btn btn-primary" id="btnShare" aria-label="Share world">Share</button>
    <button class="btn btn-ghost btn-danger" id="btnClear" aria-label="Clear all nodes and connections">Clear</button>
    <div class="hdiv" aria-hidden="true"></div>
    <button class="btn btn-icon btn-ghost" id="btnOptions" aria-label="Open options" aria-haspopup="dialog" title="Options (‚öô)">‚öô</button>
  </div>
</header>

<!-- WORKSPACE -->
<div class="workspace" role="main">

  <!-- SIDEBAR -->
  <nav class="sidebar" aria-label="World builder controls">
    <div class="ss">
      <div class="slabel" id="sl-search">Search</div>
      <div class="search-wrap">
        <span class="search-icon" aria-hidden="true">‚åï</span>
        <input class="search-in" id="searchInput" type="search" placeholder="Filter nodes‚Ä¶" aria-labelledby="sl-search" autocomplete="off"/>
      </div>
    </div>
    <div class="ss">
      <div class="slabel" id="sl-create">Create Node</div>
      <div class="type-grid" id="typeGrid" role="group" aria-labelledby="sl-create"></div>
    </div>
    <div class="ss">
      <div class="slabel" id="sl-tool">Tool</div>
      <div class="tools-row" role="group" aria-labelledby="sl-tool">
        <button class="tbtn" id="toolSel" aria-pressed="true"><span aria-hidden="true">‚Üñ</span>Select</button>
        <button class="tbtn" id="toolCon" aria-pressed="false"><span aria-hidden="true">‚áù</span>Connect</button>
      </div>
      <p class="fhint" style="margin-top:.42rem">S = select &nbsp;¬∑&nbsp; C = connect</p>
    </div>
    <div class="ss" style="padding-bottom:.38rem">
      <div class="slabel">Nodes <span class="scount" id="nodeCount" aria-live="polite" aria-atomic="true">0</span></div>
    </div>
    <div class="nodes-list" id="nodesList" role="list" aria-label="Node list"></div>
  </nav>

  <!-- CANVAS -->
  <div class="canvas-wrap" id="canvas" role="application"
    aria-label="World canvas. Tab to cycle nodes. Arrow keys move selected node. Enter or E to edit. Delete to remove."
    tabindex="0">
    <div class="empty-st" id="emptySt" aria-hidden="true">
      <div class="est-h">NEXUS</div>
      <div class="est-b">Click a type in the sidebar to create a node<br>Double-click the canvas ¬∑ Scroll to zoom ¬∑ Drag to pan</div>
    </div>
    <div class="world" id="world" aria-hidden="true">
      <svg id="svgLayer" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <marker id="arr" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="var(--accent)" opacity=".8"/></marker>
          <marker id="arrs" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="var(--accent)"/></marker>
        </defs>
      </svg>
    </div>
    <div class="conn-banner" id="connBanner" role="status" aria-live="polite">Click a node to connect ‚Äî Esc to cancel</div>
    <div class="zoom-badge" id="zoomBadge" aria-hidden="true">100%</div>
  </div>
</div>

<!-- NODE MODAL -->
<div class="modal-bg" id="nodeModal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="modal">
    <button class="mclose" id="mClose" aria-label="Close dialog">‚úï</button>
    <div class="modal-hd"><h2 class="modal-title" id="mTitle">Node</h2></div>
    <div class="fl">
      <label class="flabel" for="fName">Name <span aria-hidden="true">*</span></label>
      <input class="finput" id="fName" placeholder="Node name‚Ä¶" required aria-required="true" autocomplete="off"/>
    </div>
    <div class="fl">
      <label class="flabel" for="fType">Type</label>
      <select class="fselect" id="fType"></select>
    </div>
    <div class="fl">
      <label class="flabel" for="fDesc">Description</label>
      <textarea class="ftextarea" id="fDesc" placeholder="Describe this node‚Ä¶" rows="3"></textarea>
    </div>
    <div class="fl">
      <span class="flabel" id="tagsLbl">Tags</span>
      <div class="tags-box" id="fTagsBox" role="group" aria-labelledby="tagsLbl" aria-describedby="tagsHint"></div>
      <p class="fhint" id="tagsHint">Type and press Enter to add a tag</p>
    </div>
    <div class="fl">
      <span class="flabel" id="colorLbl">Color</span>
      <div class="swatches" id="fSwatches" role="radiogroup" aria-labelledby="colorLbl"></div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost btn-danger" id="fBtnDel" style="display:none">Delete node</button>
      <button class="btn" id="fBtnCancel" style="margin-left:auto">Cancel</button>
      <button class="btn btn-primary" id="fBtnSave">Save</button>
    </div>
  </div>
</div>

<!-- CONTEXT MENUS -->
<div class="ctx" id="ctxN" role="menu" aria-label="Node actions">
  <button class="ctx-it" data-a="edit"  role="menuitem"><span aria-hidden="true">‚úé</span>Edit</button>
  <button class="ctx-it" data-a="conn"  role="menuitem"><span aria-hidden="true">‚áù</span>Connect from here</button>
  <button class="ctx-it" data-a="dup"   role="menuitem"><span aria-hidden="true">‚äû</span>Duplicate</button>
  <div class="ctx-sep" role="separator"></div>
  <button class="ctx-it red" data-a="del" role="menuitem"><span aria-hidden="true">‚úï</span>Delete</button>
</div>
<div class="ctx" id="ctxL" role="menu" aria-label="Connection actions">
  <button class="ctx-it red" data-a="del-link" role="menuitem"><span aria-hidden="true">‚úï</span>Delete connection</button>
</div>

<!-- OPTIONS PANEL -->
<div class="opt-overlay" id="optOv" role="dialog" aria-modal="true" aria-labelledby="optTitle">
  <div class="opt-panel">
    <div class="opt-hd">
      <h2 class="opt-title" id="optTitle">Options</h2>
      <button class="btn btn-icon btn-ghost" id="optClose" aria-label="Close options">‚úï</button>
    </div>
    <div class="opt-body">

      <div class="osect">
        <div class="osect-title">Appearance</div>
        <div class="orow" style="flex-direction:column;align-items:flex-start;gap:.42rem">
          <span class="orow-lbl">Theme</span>
          <div class="theme-pills" role="radiogroup" aria-label="Theme">
            <button class="tpill on" data-theme="light" role="radio" aria-checked="true">‚òÄ Light</button>
            <button class="tpill" data-theme="dark"  role="radio" aria-checked="false">‚òæ Dark</button>
            <button class="tpill" data-theme="warm"  role="radio" aria-checked="false">üçÇ Warm</button>
            <button class="tpill" data-theme="hc"    role="radio" aria-checked="false">‚óë High Contrast</button>
          </div>
        </div>
        <div class="orow">
          <div><div class="orow-lbl">Font size</div><div class="orow-hint">Scales all text in the app</div></div>
          <div class="seg" role="radiogroup" aria-label="Font size">
            <button class="seg-b on" data-scale="normal" role="radio" aria-checked="true">Aa</button>
            <button class="seg-b"   data-scale="large"  role="radio" aria-checked="false">A+</button>
            <button class="seg-b"   data-scale="xlarge" role="radio" aria-checked="false">A++</button>
          </div>
        </div>
        <div class="orow">
          <div><div class="orow-lbl">Show grid</div><div class="orow-hint">Background dot grid on canvas</div></div>
          <label class="tog" aria-label="Toggle grid">
            <input type="checkbox" id="optGrid" checked/>
            <div class="tog-track"><div class="tog-thumb"></div></div>
          </label>
        </div>
      </div>

      <div class="osect">
        <div class="osect-title">Accessibility</div>
        <div class="orow">
          <div><div class="orow-lbl">Reduce motion</div><div class="orow-hint">Disables animations</div></div>
          <label class="tog" aria-label="Toggle reduced motion">
            <input type="checkbox" id="optMotion"/>
            <div class="tog-track"><div class="tog-thumb"></div></div>
          </label>
        </div>
        <div class="orow">
          <div><div class="orow-lbl">Enhanced focus indicators</div><div class="orow-hint">Larger, more visible outlines</div></div>
          <label class="tog" aria-label="Toggle enhanced focus indicators">
            <input type="checkbox" id="optFocus"/>
            <div class="tog-track"><div class="tog-thumb"></div></div>
          </label>
        </div>
        <div class="orow">
          <div><div class="orow-lbl">Show link counts</div><div class="orow-hint">Display connection count on nodes</div></div>
          <label class="tog" aria-label="Toggle link count display">
            <input type="checkbox" id="optCC" checked/>
            <div class="tog-track"><div class="tog-thumb"></div></div>
          </label>
        </div>
        <div class="orow">
          <div><div class="orow-lbl">Show node tags</div><div class="orow-hint">Display tags on nodes in canvas</div></div>
          <label class="tog" aria-label="Toggle node tag display">
            <input type="checkbox" id="optTags" checked/>
            <div class="tog-track"><div class="tog-thumb"></div></div>
          </label>
        </div>
      </div>

      <div class="osect">
        <div class="osect-title">Keyboard Shortcuts</div>
        <div class="kb-grid">
          <kbd>S</kbd><span>Select tool</span>
          <kbd>C</kbd><span>Connect tool</span>
          <kbd>E</kbd><span>Edit selected node</span>
          <kbd>Del</kbd><span>Delete selected</span>
          <kbd>Tab</kbd><span>Cycle nodes</span>
          <kbd>‚Üë‚Üì‚Üê‚Üí</kbd><span>Move selected node</span>
          <kbd>Esc</kbd><span>Cancel / deselect</span>
          <kbd>Ctrl+S</kbd><span>Export world</span>
        </div>
      </div>

      <div class="osect">
        <div class="osect-title">Data</div>
        <div style="display:flex;flex-direction:column;gap:.38rem">
          <button class="btn" id="oExport" style="width:100%">Export world (.json)</button>
          <button class="btn" id="oImport" style="width:100%">Import world (.json)</button>
          <button class="btn btn-ghost btn-danger" id="oClear" style="width:100%">Clear all nodes</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="share-panel" id="sharePanel">
    <div class="modal-title">Share Your Nexus</div>
    <p style="color: var(--text-muted); margin-bottom: 1rem;">
        Share this link with someone to collaborate in real-time:
    </p>
    <div class="share-url" id="shareUrl" tabindex="0" style="user-select: all;"></div>
    <button class="btn btn-primary" id="copyUrlBtn" style="width:100%; margin-top:.5rem;"><span>Copy URL</span></button>
    <div class="collaborators" style="margin-top:1rem;">
        <div class="sidebar-title">Collaborators</div>
        <div id="collaboratorsList"></div>
    </div>
    <button class="btn" id="closeShareBtn" style="width: 100%; margin-top: 1rem;"><span>Close</span></button>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none" aria-hidden="true"/>
<script src="script.js"></script>
</body>
</html>